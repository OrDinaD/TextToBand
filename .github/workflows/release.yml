name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Get tag information
      id: tag_info
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
        
        # Get previous tag for changelog
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        TAG_NAME=${{ steps.tag_info.outputs.tag_name }}
        PREV_TAG=${{ steps.tag_info.outputs.prev_tag }}
        
        echo "üìã **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ä—Å–∏–∏ $TAG_NAME**" > changelog.md
        echo "" >> changelog.md
        
        if [ ! -z "$PREV_TAG" ]; then
          echo "üîÑ **–ö–æ–º–º–∏—Ç—ã —Å $PREV_TAG:**" >> changelog.md
          git log --pretty=format:"- %s (%an)" $PREV_TAG..HEAD >> changelog.md
        else
          echo "üéâ **–ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑!**" >> changelog.md
          echo "" >> changelog.md
          echo "–≠—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è TextToBand - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Mi Band." >> changelog.md
        fi
        
        echo "" >> changelog.md
        echo "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**" >> changelog.md
        echo "- –ö–æ–º–º–∏—Ç–æ–≤: $(git rev-list --count HEAD)" >> changelog.md
        echo "- Swift —Ñ–∞–π–ª–æ–≤: $(find . -name '*.swift' | wc -l)" >> changelog.md
        echo "- –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: $(find . -name '*.swift' -exec wc -l {} + | tail -n1 | awk '{print $1}')" >> changelog.md
        
        # Read the changelog for output
        CHANGELOG=$(cat changelog.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Build for release
      run: |
        echo "üî® Building release version..."
        xcodebuild -project TextToBand.xcodeproj \
                   -scheme TextToBand \
                   -configuration Release \
                   -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
                   clean build | xcpretty

    - name: Run tests
      run: |
        echo "üß™ Running final tests..."
        xcodebuild -project TextToBand.xcodeproj \
                   -scheme TextToBand \
                   -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
                   test | xcpretty

    - name: Create Export Options
      run: |
        echo "‚öôÔ∏è Creating export options for local builds..."
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string></string>
            <key>compileBitcode</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
        </dict>
        </plist>
        EOF

    - name: Create source archive
      run: |
        echo "üì¶ Creating source archive with build tools..."
        git archive --format=zip --prefix=TextToBand-${{ steps.tag_info.outputs.version }}-source/ HEAD > TextToBand-${{ steps.tag_info.outputs.version }}-source.zip
        
        # Create build instructions
        cat > BUILD_IPA.md << EOF
        # üì± –°–±–æ—Ä–∫–∞ IPA —Ñ–∞–π–ª–∞
        
        ## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
        - macOS —Å Xcode 15.0+
        - Apple Developer –∞–∫–∫–∞—É–Ω—Ç (–¥–ª—è –ø–æ–¥–ø–∏—Å–∏)
        
        ## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        
        1. –û—Ç–∫—Ä–æ–π—Ç–µ TextToBand.xcodeproj –≤ Xcode
        2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à Team –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Signing & Capabilities
        3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã:
        
        \`\`\`bash
        # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
        xcodebuild -project TextToBand.xcodeproj \\
                   -scheme TextToBand \\
                   -configuration Release \\
                   -archivePath "TextToBand.xcarchive" \\
                   -destination 'generic/platform=iOS' \\
                   clean archive
        
        # –≠–∫—Å–ø–æ—Ä—Ç IPA
        xcodebuild -exportArchive \\
                   -archivePath "TextToBand.xcarchive" \\
                   -exportPath "." \\
                   -exportOptionsPlist ExportOptions.plist
        \`\`\`
        
        4. –ü–æ–ª—É—á–∏—Ç–µ —Ñ–∞–π–ª TextToBand.ipa –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        EOF
        
        # Add build instructions to archive
        zip -u TextToBand-${{ steps.tag_info.outputs.version }}-source.zip BUILD_IPA.md ExportOptions.plist

    - name: Generate release notes
      id: release_notes
      run: |
        NOTES="${{ steps.changelog.outputs.changelog }}

        ## üì± **–£—Å—Ç–∞–Ω–æ–≤–∫–∞**
        
        ### –°–æ–∑–¥–∞–Ω–∏–µ IPA —Ñ–∞–π–ª–∞:
        1. –°–∫–∞—á–∞–π—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ \`TextToBand-${{ steps.tag_info.outputs.version }}-source.zip\`
        2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
        3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ —Ñ–∞–π–ª–µ \`BUILD_IPA.md\` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è IPA
        4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π IPA —á–µ—Ä–µ–∑ iTunes, Xcode –∏–ª–∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        
        ### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:
        1. –°–∫–∞—á–∞–π—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ \`TextToBand-${{ steps.tag_info.outputs.version }}-source.zip\`
        2. –û—Ç–∫—Ä–æ–π—Ç–µ \`TextToBand.xcodeproj\` –≤ Xcode
        3. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ —Å–∏–º—É–ª—è—Ç–æ—Ä
        4. –ù–∞–∂–º–∏—Ç–µ ‚ñ∂Ô∏è Run
        
        ## üõ† **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**
        
        - iOS 16.0+
        - Xcode 15.0+ (–¥–ª—è —Å–±–æ—Ä–∫–∏ IPA –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
        - Apple Developer –∞–∫–∫–∞—É–Ω—Ç (–¥–ª—è –ø–æ–¥–ø–∏—Å–∏ IPA)
        - Swift 5.9+ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
        
        ## üÜï **–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**
        
        - ‚úÇÔ∏è –†–∞–∑–±–∏–≤–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        - üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Mi Band —á–µ—Ä–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è iOS
        - üìã –®–∞–±–ª–æ–Ω—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
        - üìö –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        - ‚è± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –º–µ–∂–¥—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
        - üíæ –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
        - üåô –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã
        - ‚öôÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ iOS
        
        ## üêõ **–ù–∞—à–ª–∏ –±–∞–≥?**
        
        –°–æ–æ–±—â–∏—Ç–µ –æ –ø—Ä–æ–±–ª–µ–º–µ –≤ [Issues](https://github.com/OrDinaD/TextToBand/issues/new?template=bug_report.md)
        
        ## üí° **–ï—Å—Ç—å –∏–¥–µ—è?**
        
        –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ [Issues](https://github.com/OrDinaD/TextToBand/issues/new?template=feature_request.md)"
        
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_info.outputs.tag_name }}
        name: "Release ${{ steps.tag_info.outputs.tag_name }}"
        body: ${{ steps.release_notes.outputs.notes }}
        files: |
          TextToBand-${{ steps.tag_info.outputs.version }}-source.zip
        draft: false
        prerelease: false
        make_latest: true

    - name: Update CHANGELOG.md
      run: |
        # Add new version to CHANGELOG.md
        TODAY=$(date '+%Y-%m-%d')
        
        # Create new changelog entry
        echo "## [${{ steps.tag_info.outputs.version }}] - $TODAY" > new_entry.md
        echo "" >> new_entry.md
        echo "${{ steps.changelog.outputs.changelog }}" >> new_entry.md
        echo "" >> new_entry.md
        
        # Prepend to existing CHANGELOG.md (after the header)
        if [ -f CHANGELOG.md ]; then
          # Keep header and add new entry
          head -n 7 CHANGELOG.md > temp_changelog.md
          cat new_entry.md >> temp_changelog.md
          tail -n +8 CHANGELOG.md >> temp_changelog.md
          mv temp_changelog.md CHANGELOG.md
        else
          # Create new CHANGELOG.md
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "–í—Å–µ –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "–§–æ—Ä–º–∞—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/)," >> CHANGELOG.md
          echo "–∏ —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç [Semantic Versioning](https://semver.org/lang/ru/)." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat new_entry.md >> CHANGELOG.md
        fi
        
        rm new_entry.md

    - name: Commit updated CHANGELOG
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add CHANGELOG.md
        git commit -m "docs: update CHANGELOG for ${{ steps.tag_info.outputs.tag_name }}" || exit 0
        git push origin HEAD:main

    - name: Notify release
      run: |
        echo "üéâ –†–µ–ª–∏–∑ ${{ steps.tag_info.outputs.tag_name }} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
        echo "üì¶ –ê—Ä—Ö–∏–≤: TextToBand-${{ steps.tag_info.outputs.version }}-source.zip"
        echo "üîó –°—Å—ã–ª–∫–∞: https://github.com/OrDinaD/TextToBand/releases/tag/${{ steps.tag_info.outputs.tag_name }}"
